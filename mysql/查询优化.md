## 查询优化

<img src="https://i.loli.net/2020/08/27/PplHtA5KbMmwd8x.png" height="500px" width="800px">

查询快慢的判断依据是响应时间。可以将查询看作一个任务，那么它由一系列子任务组成，每个子任务都会消耗一定时间。优化查询，实际上要优化其子任务，要么消除其中一些子任务，要么减少子任务的执行次数，要么让子任务执行的更快。

- 查询请求超过了实际需要的数据，给服务器带来额外的负担，并增加了网络开销。

- MySQL是或否扫描了额外的记录

  - 扫描的行数和返回的行数
  - 扫描的访问类型
    - 全表扫描
    - 扫描索引
    - 范围扫描
    - 唯一索引查询
    - 常数引用

  ### 策略

  - 一个复杂查询还是多个简单查询
  - 切分查询，大语句可能需要锁住很多数据，占满整个事务日志、耗尽系统资源、阻塞很多小的但很重要的查询
  - 分解关联查询
    - 让缓存的效率更高
    - 分解后减少锁竞争
    - 在应用层做关联，可以更容易对数据库进行拆分，更容易做到高性能和可扩展
    - 减少冗余记录查询。在应用层做关联，意味着某条记录应用只需查询一次，而在数据库中做关联，则可能需要重复地查询一部分数据。
    - 更进一步，这样做相当于在应用中实现了哈希关联，而不是数据库中的嵌套循环关联。某些场景哈希关联的效率要高很多。
  - 查询缓存
  - LIMIT 可改写成延迟关联、在已知边界值的情况下，改写为`BETWEEN ...AND...`语句、也可以倒序而后取首部记录
  - UNTION，可以使用变量实现在第一表中未查询到时去第二张表查询。
  - 要注意数据类型的隐式转化导致无法应用索引
  - 要用小表驱动大表
  
  ### EXPLAIN
  
  一个能够获取查询执行信息的语句。查询出的信息字段如下图所示
  
  <img src="https://i.loli.net/2020/08/27/RXDtjciGrEKTQ9L.png" width="900px"/>
  
  