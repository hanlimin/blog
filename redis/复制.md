### 复制

参与复制的Redis实例划分为主节点（master）和从节点（slave）。默认情况下Redis都是主节点。每个从节点只能有一个主节点，而主节点可以同时具有多个从节点。复制的数据流是单向的，只能由主节点复制到从节点。

复制积压缓冲区是保存在主节点上的一个固定长度的队列，默认大小为1MB，当主节点有连接的从节点（slave）时创建，这时主节点响应写命令时，不大会把命令发送给从节点，还会写入复制积压缓冲区，实现保存最近已复制数据的功能，用于部分复制和复制命令丢失的数据补救。

每个Redis节点启动都会动态分配一个40位的十六进制字符串作为运行ID。运行ID的主要作用是唯一标识Redis节点，比如从节点保存主节点的运行ID识别自己正在复制的是哪个节点，因此当运行ID变化后从节点将做全量复制。

主从节点在建立复制后，它们之间维护者长连接并彼此发送心跳命令。主节点默认每隔10秒对从节点发送ping命令。从节点在主线程每隔1秒发送 replconf ack {offset}命令，给主节点上报自身当前的复制偏移量。

#### 配置

配置复制的方式有以下三种：

1）配置文件中加入slaveeof {masterHost} {masterPort}随Redis启动生效。

2）在redis-server启动命令后加入 --slaveeof {masterHost} {masterPort}生效。

3）直接使用命令：slaveeof {masterHost} {masterPort}生效。



默认情况下，从节点使用slave-read-only=yes配置为只读模式。

repl-disable-tcp-nodelay参数用于控制是否关闭TCP_NODELAY，默认关闭。当关闭时，主节点产生的命令数据无论大小都会及时发送给从节点，这样主从之间延迟会变小，但增加了网络带宽的消耗。当开启时，主节点会合并较小的TCP数据包从而节省带宽。默认发送时间间隔取决于Linux的内核，一般默认为40毫秒。



使用命令slave no one来断开复制

#### 复制过程

1）保存主节点信息

2）主从建立socket连接

3）发送ping命令

4）权限验证

5）同步数据集

6）命令持续复制

#### 管理

psync runId offset

从节点使用psync命令王城部分复制和全量复制功能。runid：从节点所复制主节点的运行ID；offset：当前从节点已复制的数据偏移量。