---
title: å®¹å™¨
date: "2020-12-10 23:10:25"
modifyDate: "2020-12-10 23:10:25"
draft: true
---

# å®¹å™¨

![java_collections_overview](/static/collections.png)

## JDK 1.0

### `Vector` ğŸ”’

åŸºäºæ•°ç»„å®ç°ï¼Œæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„åˆ—è¡¨ã€‚
åœ¨ Java 1.2åï¼Œå®ç°äº† `List` æ¥å£ã€‚

### `Stack` ğŸ”’

åŸºäº `Vector` å®ç°çš„LIFOæ ˆã€‚

### `Hashtable` ğŸ”’

å®ç°äº† `Map` æ¥å£ï¼ŒåŸºäºå“ˆå¸Œè¡¨å®ç°ï¼Œå¤§éƒ¨åˆ†æ–¹æ³•ä¸ºåŒæ­¥æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å“ˆå¸Œè¡¨ï¼Œä¸å…è®¸Keyä¸º`null`ã€‚

## Java 1.2

### `Collection`

åŸºæœ¬æ“ä½œ

```java
//Query Operations
int size();
boolean isEmpty();
boolean contains(Object element);
Iterator<E> iterator();
Object[] toArray();
<T> T[] toArray(T[] a);
// Modification Operations
boolean add(E element);
boolean remove(Object element);
//Bulk Operations
boolean containsAll(Collection<?> c);
boolean addAll(Collection<? extends E> c);
boolean removeAll(Collection<?> c);
boolean retainAll(Collection<?> c);
void clear();
// Comparison and hashing
boolean equals(Object o);
int hashCode()
```

`Collection` è¡¨ç¤ºä¸€ç»„å¯¹è±¡ï¼Œå®ƒæœ‰æ–¹æ³•å‘Šè¯‰ä½ é›†åˆï¼ˆsizeï¼ŒisEmptyï¼‰ä¸­æœ‰å¤šå°‘å…ƒç´ ï¼Œæ£€æŸ¥ç»™å®šå¯¹è±¡æ˜¯å¦åœ¨ collectionï¼ˆcontainsï¼‰ä¸­çš„æ–¹æ³•ï¼Œ ä»é›†åˆï¼ˆaddï¼Œremoveï¼‰ä¸­æ·»åŠ å’Œåˆ é™¤å…ƒç´ çš„æ–¹æ³•ï¼Œä»¥åŠæä¾›è¿­ä»£å™¨å¯¹ collectionï¼ˆiteratorï¼‰

```java
Stream<E> stream();
Stream<E> parallelStream()
```

åœ¨ Java 8ï¼Œæ·»åŠ äº†ä»åº•å±‚é›†åˆè·å¾—é¡ºåºçš„æˆ–å¹¶è¡Œçš„æµæ“ä½œæ–¹æ³•ã€‚

### `List`

```java
// Bulk Modification Operations
boolean addAll(int index, Collection<? extends E> c);
// Positional Access Operations
E get(int index);
E set(int index, E element);
void add(int index, E element);
E remove(int index);
// Search Operations
int indexOf(Object o);
int lastIndexOf(Object o);
// List Iterators
ListIterator<E> listIterator();
ListIterator<E> listIterator(int index);
// View
List<E> subList(int fromIndex, int toIndex);
```

ç»§æ‰¿è‡ª`Collection`æ¥å£ï¼Œæ·»åŠ äº†ç´¢å¼•æ“ä½œã€‚

### `ArrayList`

```java
void trimToSize();
ensureCapacity(int minCapacity)
```

å®ç°äº† `List` æ¥å£ï¼ŒåŸºäºæ•°ç»„å®ç°ï¼Œå¤šäº†ä¸¤ä¸ªå…¬å…±æ–¹æ³•ï¼š`trimToSize()`å‰ªè£æ•°ç»„é•¿åº¦ä¸ºå…ƒç´ æ•°é‡ï¼›`ensureCapacity()`ç¡®ä¿å®¹çº³æŒ‡å®šæ•°é‡å…ƒç´ ï¼Œå®¹é‡ä¸è¶³åˆ™æ‰©å®¹ã€‚

### `LinkedList`

å®ç°äº† `List`ï¼ŒåŸºäºé“¾è¡¨çš„åˆ—è¡¨ã€‚
åœ¨ Java 6 åï¼Œå®ç°äº† `Deque` æ¥å£ï¼ŒåŸºäºé“¾è¡¨çš„æ— ç•ŒåŒç«¯é˜Ÿåˆ—ã€‚

### `Set`

ç»§æ‰¿è‡ª `Collection` æ¥å£ï¼Œå®¹å™¨å†…æ¯ä¸ªå…ƒç´ ä¸é‡å¤ã€‚

### `HashSet`

å®ç°äº† `Set` æ¥å£ï¼Œæ ¹æ®æ„é€ å‚æ•°çš„ä¸åŒï¼Œä½¿ç”¨ `HashMap` æˆ– `LinkedHashMap` çš„Keyå€¼æ¥å‚¨å­˜æ•°æ®ã€‚

### `TreeSet`

å®ç°äº† `NavigableSet` æ¥å£ï¼Œå†…éƒ¨ä½¿ç”¨`TreeMap`çš„Keyå€¼æ¥å‚¨å­˜æ•°æ®ã€‚

### 

### `Map`
```java
// Query Operations
int size();
boolean isEmpty();
boolean containsKey(Object key);
boolean containsValue(Object value);
V get(Object key);
// Modification Operations
V put(K key, V value);
V remove(Object key);
// Bulk Operations
void putAll(Map<? extends K, ? extends V> m);
void clear();
// Views
Set<K> keySet();
Collection<V> values();
Set<Map.Entry<K, V>> entrySet();
// Comparison and hashing
boolean equals(Object o);
int hashCode();
```

å“ˆå¸Œè¡¨æ•°æ®ç»“æ„çš„é¡¶å±‚æ¥å£ã€‚

### `HashMap`

å®ç°äº† `Map` æ¥å£ï¼ŒåŸºäºæ•°ç»„çš„å“ˆå¸Œè¡¨ã€‚
å†…éƒ¨ä½¿ç”¨æ•°ç»„å‚¨å­˜æ•°æ®ï¼Œæ¯ä¸ªå…ƒç´ ä½¿ç”¨å†…éƒ¨ç±» `Entry` è¡¨ç¤ºã€‚`Entry`å†…å‚¨å­˜ç€Valueå€¼ã€Keyå€¼ã€Keyçš„å“ˆå¸Œå€¼ã€ä¸‹ä¸€ä¸ª`Entry`çš„å¼•ç”¨ã€‚æ‰§è¡Œæ“ä½œæ—¶ï¼Œè®¡ç®—å‡ºKeyçš„å“ˆå¸Œå€¼ï¼Œå†ä»¥å“ˆå¸Œå€¼ä¸æ•°ç»„é•¿åº¦åšå–æ¨¡è¿ç®—ï¼Œç»“æœå³ä¸ºå¯¹åº”çš„æ•°ç»„ç´¢å¼•å€¼ã€‚å…¶ä¸­ï¼ŒKeyä¸º`null`çš„å€¼æ—¶ï¼Œå›ºå®šå‚¨å­˜åœ¨ç´¢å¼•ä¸º0çš„æ¡¶å†…ã€‚å½“è®¡ç®—å‡ºçš„ç´¢å¼•å€¼å†²çªæ—¶ï¼Œä»¥Keyçš„å“ˆå¸Œå€¼ã€å¯¹è±¡å¼•ç”¨ã€è°ƒç”¨`equals`æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€ä¸ªKeyï¼Œç›¸åŒåˆ™ç›´æ¥æ›¿æ¢Valueï¼Œä¸åŒåˆ™åœ¨åŒä¸ªæ¡¶å†…å½¢æˆé“¾è¡¨æ¥å‚¨å­˜ã€‚å½“æ•°ç»„å†…çš„å…ƒç´ æ•°é‡è¶…è¿‡æŒ‡å®šé˜ˆå€¼æ—¶ï¼Œåˆ›å»ºå‡ºåŸæ•°ç»„ä¸¤å€é•¿åº¦çš„æ–°æ•°ç»„ï¼Œå°†åŸæ•°ç»„çš„æ¯ä¸ªå…ƒç´ é‡æ–°è®¡ç®—ç´¢å¼•å€¼æ·»åŠ åˆ°æ–°æ•°ç»„ä¸­ï¼Œæœ€åæ–°æ•°ç»„æ›¿æ¢åŸæ•°ç»„ã€‚

Java 8ï¼Œåœ¨æ¡¶ä¸Šå½¢æˆçš„é“¾è¡¨é•¿åº¦è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œé“¾è¡¨è½¬çº¢é»‘æ ‘ã€‚

### `TreeMap`

å®ç°äº† `Map`ã€`NaviableMap` æ¥å£ï¼ŒåŸºäºçº¢é»‘æ ‘å®ç°ï¼Œæ’åºæ—¶æŒ‰ç…§é”®çš„è‡ªç„¶åºï¼ˆè¦æ±‚å®ç° Comparable æ¥å£ï¼‰æˆ–è€…æä¾›ä¸€ä¸ª Comparator ç”¨äºæ’åºã€‚

## Java 1.4

### `LinkedHashMap`

ç»§æ‰¿è‡ª`HashMap`ï¼Œå†…éƒ¨ä½¿ç”¨åŒå‘é“¾è¡¨ä¿å­˜äº†é”®å€¼å¯¹çš„æ·»åŠ é¡ºåºã€‚

### `LinkedHashSet`

ç»§æ‰¿è‡ª`HashSet`ï¼Œå†…éƒ¨ä½¿ç”¨ `LinkedHashMap` çš„Keyå€¼æ¥å‚¨å­˜æ•°æ®ã€‚

## Java 5

### `CopyOnWriteArrayList` ğŸ”’

å®ç°äº† `List` æ¥å£ï¼ŒåŸºäºæ•°ç»„çš„æ— ç•Œåˆ—è¡¨ã€‚å†™æ“ä½œåˆ™é€šè¿‡åº•å±‚æ•°ç»„çš„æ–°å‰¯æœ¬æ¥å®ç°ï¼Œæ˜¯ä¸€ç§è¯»å†™åˆ†ç¦»çš„å¹¶å‘ç­–ç•¥ã€‚å†™æ—¶çº¿ç¨‹å®‰å…¨æ˜¯é€šè¿‡ `ReentrantLock` é”å®ç°çš„ã€‚

### `CopyOnWriteArraySet` ğŸ”’

å®ç°äº† `List` æ¥å£ï¼Œä½¿ç”¨CopyOnWriteArrayListå®ç°çš„æ— ç•Œé›†åˆã€‚

### `Queue`

```java
// throws exception
boolean add(E e);
E element();
E remove();
// returns speacl value
boolean offer(E e);
E peek();
E poll();
```

ç»§æ‰¿è‡ª`Collection`æ¥å£ï¼Œé˜Ÿåˆ—ç»“æ„ã€‚

### `PriorityQueue`

å®ç°äº† `Queue` æ¥å£ï¼ŒåŸºäºæ•°ç»„çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼Œä¹Ÿå¯ä»¥å«ä¼˜å…ˆå †ã€‚ä½¿ç”¨æ—¶å…ƒç´ å¿…é¡»å®ç°äº† `Comparable` æ¥å£ï¼Œæˆ–è€…åˆ›å»º `PriorityQueue` æ—¶æŒ‡å®šäº†æ¯”è¾ƒå™¨ `Comparator`ã€‚

### `BlockingQueue` ğŸ”’

```java
boolean add(E e);
boolean offer(E e);
void put(E e) throws InterruptedException;
boolean offer(E e, long timeout, TimeUnit unit)throws InterruptedException;
E take() throws InterruptedException;
E poll(long timeout, TimeUnit unit)throws InterruptedException;
int remainingCapacity();
boolean remove(Object o);
public boolean contains(Object o);
int drainTo(Collection<? super E> c);
int drainTo(Collection<? super E> c, int maxElements);
```

ç»§æ‰¿è‡ª `Queue`, æ‰©å±•äº†ä¸¤ä¸ªç‰¹æ®Šæ“ä½œã€‚ä¸¤ä¸ªæ“ä½œæ˜¯ï¼šåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè·å–å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å˜ä¸ºéç©ºï¼›å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå­˜å‚¨å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å¯ç”¨ã€‚é˜»å¡é˜Ÿåˆ—å¸¸ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åœºæ™¯ï¼Œç”Ÿäº§è€…æ˜¯å¾€é˜Ÿåˆ—é‡Œæ·»åŠ å…ƒç´ çš„çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…æ˜¯ä»é˜Ÿåˆ—é‡Œæ‹¿å…ƒç´ çš„çº¿ç¨‹ã€‚é˜»å¡é˜Ÿåˆ—å°±æ˜¯ç”Ÿäº§è€…å­˜æ”¾å…ƒç´ çš„å®¹å™¨ï¼Œè€Œæ¶ˆè´¹è€…ä¹Ÿåªä»å®¹å™¨é‡Œæ‹¿å…ƒç´ ã€‚

### `DelayQueue` ğŸ”’

å®ç°äº† `BlockingQueue` æ¥å£ï¼ŒåŸºäº `PriorityQueue` çš„æ— ç•Œå»¶æ—¶é˜Ÿåˆ—ï¼Œä½¿ç”¨ `ReentrantLock` é”å®ç°é˜»å¡ã€‚é˜Ÿåˆ—ä¸­å…ƒç´ å¿…é¡»å®ç° `Delayed` æ¥å£ï¼ŒæŒ‡å®šå…ƒç´ çš„å»¶æ—¶æ—¶é—´ï¼Œ å¦‚æœå…ƒç´ æ²¡æœ‰è¾¾åˆ°å»¶æ—¶æ—¶é—´ï¼Œå°±é˜»å¡å½“å‰çº¿ç¨‹ã€‚

### `ArrayBlockingQueue` ğŸ”’

å®ç°äº† `BlockingQueue` æ¥å£ï¼ŒåŸºäºæ•°ç»„å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œä½¿ç”¨ `ReentrantLock` ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œ`Condition` å®ç°ç­‰å¾…é€šçŸ¥ã€‚

### `SynchronousQueue` ğŸ”’

å®ç°äº† `BlockingQueue` æ¥å£ï¼Œä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œå®ç°è¿›è¡Œçº¿ç¨‹ä¹‹é—´çš„å…ƒç´ ä¼ é€ã€‚é€šè¿‡ `LockSupport` å®ç°é˜»å¡ç­‰å¾…ï¼Œé€šè¿‡CASå®ç°æ›´æ–°æ“ä½œåŸå­æ€§ã€‚ ç”±äºå¯¹äºä¼ é€’æ€§åœºæ™¯è¿›è¡Œäº†æŸç§å……åˆ†çš„ä¼˜åŒ–ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯ä¸éœ€è¦é”ï¼Œå› æ­¤åœ¨åªéœ€è¦åŒæ­¥ï¼Œä¸éœ€è¦å¤§é‡å­˜å‚¨å…ƒç´ çš„åœºæ™¯ä¸‹ååé‡å¾ˆé«˜ã€‚æ”¯æŒå…¬å¹³ç­–ç•¥ï¼Œä¼šé™ä½ååé‡ï¼Œé»˜è®¤ä¸‹æ˜¯ä½¿ç”¨ä¸å…¬å¹³ç­–ç•¥ã€‚

### `LinkedBlockingQueue` ğŸ”’

å®ç°äº† `BlockingQueue` æ¥å£ï¼ŒåŸºäºé“¾è¡¨çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ä½¿ç”¨ `ReentranLocK` ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½¿ç”¨ `ReentranLocK` çš„ `Condition` å®ç°ç­‰å¾…é€šçŸ¥ã€‚å†…éƒ¨ä½¿ç”¨ä¸¤ä¸ªé”åˆ†åˆ«å¯¹åº”å…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œã€‚

### `PriorityBlockingQueue` ğŸ”’

å®ç°äº† `BlockingQueue` æ¥å£ï¼ŒåŸºäº `PriorityQueue` çš„æ— ç•Œé˜»å¡ä¼˜å…ˆé˜Ÿåˆ—ã€‚ä½¿ç”¨ `ReentrantLock` ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½¿ç”¨ `ReentranLocK` çš„ `Condition` å®ç°ç­‰å¾…é€šçŸ¥ã€‚

### `ConcurrentLinkedQueue` ğŸ”’

å®ç°äº† `Queue` æ¥å£ï¼ŒåŸºäºé“¾è¡¨å®ç°çš„æ— ç•Œæ— é˜»å¡é˜Ÿåˆ—ï¼Œä½¿ç”¨CASä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

`offer()` çš„ä»£ç å¦‚ä¸‹ï¼š

```java
public boolean offer(E e) {
    checkNotNull(e);
    final Node<E> newNode = new Node<E>(e);
        //è‡ªæ—‹ï¼Œtæ˜¯tailèŠ‚ç‚¹çš„å¼•ç”¨ï¼Œpä¸ºt
    for (Node<E> t = tail, p = t;;) {
        //qä¸ºtailçš„åç»§
        Node<E> q = p.next;
        if (q == null) {
            // æ­¤æ—¶tailåæ²¡æœ‰å…¶å®ƒçº¿ç¨‹æ·»åŠ çš„æ–°èŠ‚ç‚¹
            if (p.casNext(null, newNode)) {
            		//æ¯æ–°å¢ä¸¤ä¸ªèŠ‚ç‚¹æ‰ä¼šæ›´æ–°å°¾èŠ‚ç‚¹æŒ‡é’ˆ
                if (p != t)
                    casTail(t, newNode); 
                return true;
            }
        }
        else if (p == q)
            // å¹¶å‘ç¯å¢ƒå¯¼è‡´pæŒ‡å‘çš„ä½¿å“¨å…µèŠ‚ç‚¹ã€‚ä¿®æ”¹pçš„æŒ‡å‘çš„èŠ‚ç‚¹ï¼Œå¦‚æœtailä¿®æ”¹äº†ï¼Œå°±å°†pç½®ä¸ºtailï¼Œå¦åˆ™å°†pç½®ä¸ºhead
            p = (t != (t = tail)) ? t : head;
        else
            /**
             * å¦‚æœqä¸ç­‰äºnullï¼Œä¸”pä¸ç­‰äºqï¼Œè¿™æ—¶å¯èƒ½æœ‰å…¶ä»–çš„çº¿ç¨‹æ°å¥½æŠ¢å…ˆä¸€æ­¥æ·»åŠ äº†ä¸€ä¸ªèŠ‚ç‚¹
             * åˆ™åˆ¤æ–­pä¸tæ˜¯å¦ä¸åŒï¼Œå³tailæ˜¯å¦æ”¹å˜ï¼š
             * 1. pä¸tç›¸åŒï¼Œè¡¨ç¤ºè¿™æ˜¯ç¬¬ä¸€å¾ªç¯ä¸”tæœªæ”¹å˜ï¼Œæ­¤æ—¶å°†qèµ‹å€¼ç»™pï¼Œå³åç§»ï¼›
             * 2. pä¸tä¸åŒï¼Œä½†tæœªå‘ç”Ÿæ”¹å˜ï¼Œè¯´æ˜på·²ç»åç§»äº†ï¼Œæ­¤æ—¶å°†qèµ‹å€¼ç»™pï¼Œå³ç»§ç»­åç§»ï¼›
             * 3. pä¸tä¸åŒï¼Œä¸”tå‘ç”Ÿäº†æ”¹å˜ï¼Œå³tailæ›´æ–°äº†ï¼Œæ­¤æ—¶å°†pæŒ‡å‘tï¼ˆå³æ–°çš„tailï¼ŒæŒ‡å‘å°¾éƒ¨æ˜¯æœ€ä¼˜æ–¹å¼ï¼‰
             */
            p = (p != t && t != (t = tail)) ? t : q;
    }
}
```

`offer()` æ–¹æ³•é€»è¾‘å¤§è‡´åˆ†ä¸ºä¸‰æ­¥ï¼š

1. æ‰¾åˆ°çœŸæ­£çš„å°¾èŠ‚ç‚¹pã€‚
2. CASæ›´æ–°`p.next`ã€‚
3. åˆ¤æ–­æ˜¯å¦CASæ›´æ–°tailä½ç½®ã€‚

`poll()` çš„ä»£ç å¦‚ä¸‹ï¼š

```java
public E poll() {
    restartFromHead:
    for (;;) {
        for (Node<E> h = head, p = h, q;;) {
            E item = p.item;
                // åˆ¤æ–­pçš„itemæ˜¯å¦ä¸ºnullï¼Œå¦‚æœä¸æ˜¯å°±CASæ–¹å¼è®¾ç½®ä¸ºnull
            if (item != null && p.casItem(item, null)) {
                if (p != h) 
                    //ç©ºèŠ‚ç‚¹æ•°é‡è¾¾åˆ°ä¸¤ä¸ªï¼Œç§»åŠ¨head
                    updateHead(h, ((q = p.next) != null) ? q : p);
                return item;
            }
            // éƒ½æ˜¯æ— æ•ˆèŠ‚ç‚¹
            else if ((q = p.next) == null) {
                updateHead(h, p);
                return null;
            }
            // å¹¶å‘ç¯å¢ƒï¼Œå·²è°ƒç”¨updateHeadæ–¹æ³•ï¼Œä½¿pè½¬å˜ä¸ºå“¨å…µèŠ‚ç‚¹
            else if (p == q)
                continue restartFromHead;
            else
                // å½“å‰pèŠ‚ç‚¹ä¸ºæ— æ•ˆèŠ‚ç‚¹ï¼Œç§»åŠ¨p
                p = q;
        }
    }
}
```

`pool()`æ–¹æ³•é€»è¾‘è¿‡ç¨‹ï¼š

1. æ‰¾åˆ°æœ‰æ•ˆå¤´èŠ‚ç‚¹pã€‚
2. åˆ¤æ–­èŠ‚ç‚¹på†…å®¹`item`æ˜¯å¦ä¸º`NULL`ï¼Œå¦‚æœä¸º`NULL`è¡¨ç¤ºè¯¥èŠ‚ç‚¹å·²ç»å‡ºé˜Ÿäº†ï¼Œå¦‚æœ`item`ä¸ä¸º`NULL`åˆ™ä½¿ç”¨CASæ›¿æ¢ä¸º`NULL`
3. å¦‚æœæˆåŠŸåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°å¤´ç»“ç‚¹æŒ‡é’ˆ
4. åˆ¤æ–­æ˜¯å¦CASæ›´æ–°headä½ç½®

é€šè¿‡CASä¿è¯å¤´èŠ‚ç‚¹ã€å°¾èŠ‚ç‚¹å˜åŠ¨åŸå­æ€§æ“ä½œï¼Œå°±èƒ½å®ç°é˜Ÿåˆ—å…¥é˜Ÿå‡ºé˜Ÿçº¿ç¨‹å®‰å…¨ã€‚

HOPS(å»¶è¿Ÿæ›´æ–°çš„ç­–ç•¥)çš„è®¾è®¡

é€šè¿‡å¯¹offerå’Œpollæ–¹æ³•çš„åˆ†æï¼Œæˆ‘ä»¬å‘ç°tailå’Œheadæ˜¯å»¶è¿Ÿæ›´æ–°çš„ï¼Œä¸¤è€…æ›´æ–°è§¦å‘æ—¶æœºä¸ºï¼š

tailæ›´æ–°è§¦å‘æ—¶æœºï¼šå½“tailæŒ‡å‘çš„èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºnullçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œå®šä½é˜Ÿåˆ—çœŸæ­£çš„é˜Ÿå°¾èŠ‚ç‚¹çš„æ“ä½œï¼Œæ‰¾åˆ°é˜Ÿå°¾èŠ‚ç‚¹åå®Œæˆæ’å…¥ä¹‹åæ‰ä¼šé€šè¿‡casTailè¿›è¡Œtailæ›´æ–°ï¼›å½“tailæŒ‡å‘çš„èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºnullçš„æ—¶å€™ï¼Œåªæ’å…¥èŠ‚ç‚¹ä¸æ›´æ–°tailã€‚

headæ›´æ–°è§¦å‘æ—¶æœºï¼šå½“headæŒ‡å‘çš„èŠ‚ç‚¹çš„itemåŸŸä¸ºnullçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œå®šä½é˜Ÿåˆ—çœŸæ­£çš„é˜Ÿå¤´èŠ‚ç‚¹çš„æ“ä½œï¼Œæ‰¾åˆ°é˜Ÿå¤´èŠ‚ç‚¹åå®Œæˆåˆ é™¤ä¹‹åæ‰ä¼šé€šè¿‡updateHeadè¿›è¡Œheadæ›´æ–°ï¼›å½“headæŒ‡å‘çš„èŠ‚ç‚¹çš„itemåŸŸä¸ä¸ºnullçš„æ—¶å€™ï¼Œåªåˆ é™¤èŠ‚ç‚¹ä¸æ›´æ–°headã€‚

å¦‚æœè®©tailæ°¸è¿œä½œä¸ºé˜Ÿåˆ—çš„é˜Ÿå°¾èŠ‚ç‚¹ï¼Œå®ç°çš„ä»£ç é‡ä¼šæ›´å°‘ï¼Œè€Œä¸”é€»è¾‘æ›´æ˜“æ‡‚ã€‚ä½†æ˜¯ï¼Œè¿™æ ·åšæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå¦‚æœå¤§é‡çš„å…¥é˜Ÿæ“ä½œï¼Œæ¯æ¬¡éƒ½è¦æ‰§è¡ŒCASè¿›è¡Œtailçš„æ›´æ–°ï¼Œæ±‡æ€»èµ·æ¥å¯¹æ€§èƒ½ä¹Ÿä¼šæ˜¯å¤§å¤§çš„æŸè€—ã€‚å¦‚æœèƒ½å‡å°‘CASæ›´æ–°çš„æ“ä½œï¼Œæ— ç–‘å¯ä»¥å¤§å¤§æå‡å…¥é˜Ÿçš„æ“ä½œæ•ˆç‡ï¼Œæ‰€ä»¥æ¯é—´éš”1æ¬¡(tailå’Œé˜Ÿå°¾èŠ‚ç‚¹çš„è·ç¦»ä¸º1)è¿›è¡Œæ‰åˆ©ç”¨CASæ›´æ–°tailã€‚å¯¹headçš„æ›´æ–°ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œè™½ç„¶ï¼Œè¿™æ ·è®¾è®¡ä¼šå¤šå‡ºåœ¨å¾ªç¯ä¸­å®šä½é˜Ÿå°¾èŠ‚ç‚¹ï¼Œä½†æ€»ä½“æ¥è¯´è¯»çš„æ“ä½œæ•ˆç‡è¦è¿œè¿œé«˜äºå†™çš„æ€§èƒ½ï¼Œå› æ­¤ï¼Œå¤šå‡ºæ¥çš„åœ¨å¾ªç¯ä¸­å®šä½å°¾èŠ‚ç‚¹çš„æ“ä½œçš„æ€§èƒ½æŸè€—ç›¸å¯¹è€Œè¨€æ˜¯å¾ˆå°çš„ã€‚ 

ConcurrentLinkedQueueé€šè¿‡æ— é”æ¥åšåˆ°äº†æ›´é«˜çš„å¹¶å‘é‡ï¼Œæ˜¯ä¸ªé«˜æ€§èƒ½çš„é˜Ÿåˆ—ï¼Œä½†æ˜¯ä½¿ç”¨åœºæ™¯ç›¸å¯¹ä¸å¦‚é˜»å¡é˜Ÿåˆ—å¸¸è§ï¼Œæ¯•ç«Ÿå–æ•°æ®ä¹Ÿè¦ä¸åœçš„å»å¾ªç¯ï¼Œä¸å¦‚é˜»å¡çš„é€»è¾‘å¥½è®¾è®¡ï¼Œä½†æ˜¯åœ¨å¹¶å‘é‡ç‰¹åˆ«å¤§çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œæ€§èƒ½ä¸Šå¥½å¾ˆå¤šï¼Œè€Œä¸”è¿™ä¸ªé˜Ÿåˆ—çš„è®¾è®¡ä¹Ÿæ˜¯ç‰¹åˆ«è´¹åŠ›ï¼Œå°¤å…¶çš„ä½¿ç”¨çš„æ”¹è‰¯ç®—æ³•å’Œå¯¹å“¨å…µçš„å¤„ç†ã€‚æ•´ä½“çš„æ€è·¯éƒ½æ˜¯æ¯”è¾ƒä¸¥è°¨çš„ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä½¿ç”¨äº†æ— é”é€ æˆçš„ï¼Œæˆ‘ä»¬è‡ªå·±ä½¿ç”¨æ— é”çš„æ¡ä»¶çš„è¯ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯ä¸ªä¸é”™çš„å‚è€ƒã€‚

### `EnumMap`

ç»§æ‰¿è‡ª `AbstractMap` ç±»ï¼Œè¦æ±‚ Key ä¸º Enum ç±»å‹ï¼Œå†…éƒ¨ä½¿ç”¨æ•°ç»„å‚¨å­˜å…ƒç´ ï¼Œç´¢å¼•å°±æ˜¯ Enum çš„åºå·ã€‚

### `ConcurrentMap` ğŸ”’

```java
V putIfAbsent(K key, V value);
boolean remove(Object key, Object value);
boolean replace(K key, V oldValue, V newValue);
V replace(K key, V value);
```

ç»§æ‰¿è‡ª `Map` æ¥å£ï¼Œæ·»åŠ äº†3ç§åŸå­æ“ä½œæ–¹æ³•ã€‚

### `ConcurrentHashMap` ğŸ”’

å®ç°äº† `ConcurrentMap` æ¥å£ï¼ŒåŸºäº``çš„å“ˆå¸Œè¡¨ã€‚

åœ¨HashTableçš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨åˆ†æ®µé”æœºåˆ¶ï¼Œå‡å°é”çš„é¢—ç²’ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œå†²çªä½¿ç”¨é“¾è¡¨è§£å†³ã€‚ConcurrentHashMapç”±Segmentåˆ’åˆ†æˆå¤šä¸ªæ•°æ®æ®µã€‚å†…éƒ¨ç±»Segmentç»§æ‰¿è‡ªReentrantLockï¼Œå†…éƒ¨å‚¨å­˜ç€HashEntryæ•°ç»„ï¼Œéƒ¨åˆ†æ“ä½œä½¿ç”¨ReentrantLockçš„é”è¾¾æˆåŒæ­¥ã€‚åŒæ®µå¤šçº¿ç¨‹ReentrantLockè·å–é”å¯èƒ½å¯¼è‡´çº¿ç¨‹ç­‰å¾…ã€‚

segmentShiftå’ŒsegmentMaskè¿™ä¸¤ä¸ªå…¨å±€å˜é‡çš„ä¸»è¦ä½œç”¨æ˜¯æ ¹æ®keyçš„hashå€¼å¾—é«˜ä½ç¡®å®šsegmentç´¢å¼•ã€‚

keyã€valueä¸èƒ½ä¸ºnullã€‚

åœ¨Java 7ï¼Œæ·»åŠ å°è¯•è‡ªæ—‹è·å–é”ï¼Œå¦‚æœé‡è¯•æ¬¡æ•°è¾¾åˆ°äº†`MAX_SCAN_RETRIES` åˆ™æ”¹ä¸ºé˜»å¡é”è·å–ï¼Œä¿è¯èƒ½è·å–æˆåŠŸ ã€‚

åœ¨ Java 8ï¼Œæ”¾å¼ƒäº†åˆ†æ®µé”ï¼Œ é‡‡ç”¨äº† `CAS + synchronized` æ¥ä¿è¯å¹¶å‘å®‰å…¨æ€§ã€‚åŒæ—¶ä¸ºäº†é˜²æ­¢å“ˆå¸Œå†²çªä¸¥é‡æ—¶é€€åŒ–æˆé“¾è¡¨ï¼ˆå†²çªæ—¶ä¼šåœ¨è¯¥ä½ç½®ç”Ÿæˆä¸€ä¸ªé“¾è¡¨ï¼Œå“ˆå¸Œå€¼ç›¸åŒçš„å¯¹è±¡å°±é“¾åœ¨ä¸€èµ·ï¼‰ï¼Œä¼šåœ¨é“¾è¡¨é•¿åº¦è¾¾åˆ°é˜ˆå€¼ï¼ˆ8ï¼‰åè½¬æ¢æˆçº¢é»‘æ ‘ï¼ˆæ¯”èµ·é“¾è¡¨ï¼Œæ ‘çš„æŸ¥è¯¢æ•ˆç‡æ›´ç¨³å®šï¼‰ã€‚ 

sizeæ˜¯ä¸€ä¸ªç¬é—´çš„çŠ¶æ€ï¼Œæ‰€ä»¥å®ƒå°†æ¯æ¬¡ä¿®æ”¹çš„è®¡æ•°æ”¾åœ¨äº†ConcurrentHashMapçš„å±€éƒ¨å˜é‡ä¸­ï¼Œè°ƒç”¨sizeçš„æ—¶å€™ï¼Œç›´æ¥å»è·å–è¿™ä¸ªè®¡æ•°ï¼Œæ¯”1.7æ–¹ä¾¿è®¸å¤šã€‚

## Java 6

### `Deque`

```java
// throws exception
void addFirst(E e);
void addLast(E e);
E removeFirst();
E removeLast();
E getFirst();
E getLast();
// return special value
boolean offerFirst(E e);
boolean offerLast(E e);
E peekFirst();
E peekLast();
E pollFirst();
E pollLast();
// 
boolean removeFirstOccurrence(Object o);
boolean removeLastOccurrence(Object o);
// stack operation
void push(E e);
E pop();
// reverse sequential order
Iterator<E> descendingIterator();
```

ç»§æ‰¿è‡ª`Queue`æ¥å£ï¼ŒåŒç«¯é˜Ÿåˆ—ç»“æ„ã€‚

### `ArrayDeque`

å®ç°äº† `Deque` æ¥å£ï¼ŒåŸºäºæ•°ç»„çš„æ— ç•ŒåŒç«¯é˜Ÿåˆ—ã€‚

### `BlockingDeque` ğŸ”’

```java
void putFirst(E e) throws InterruptedException;
void putLast(E e) throws InterruptedException;
boolean offerFirst(E e, long timeout, TimeUnit unit) throws InterruptedException;
boolean offerLast(E e, long timeout, TimeUnit unit) throws InterruptedException;
E takeFirst() throws InterruptedException;
E takeLast() throws InterruptedException;
E pollFirst(long timeout, TimeUnit unit) throws InterruptedException;
E pollLast(long timeout, TimeUnit unit) throws InterruptedException;
```

ç»§æ‰¿è‡ª `BlockingQueue` å’Œ `Deque` æ¥å£ï¼Œæ‰©å±•å‡ºçš„é˜»å¡åŒç«¯é˜Ÿåˆ—ã€‚

### `LinkedBlockingDeque` ğŸ”’

å®ç°äº† `BlockingDeque` æ¥å£ï¼ŒåŸºäºé“¾è¡¨çš„æ— ç•Œé˜»å¡åŒç«¯é˜Ÿåˆ—ã€‚ä½¿ç”¨ `ReentrantLock` å®ç°çº¿ç¨‹å®‰å…¨ï¼Œä½¿ç”¨ `Condition` å®ç°ç­‰å¾…é€šçŸ¥ã€‚

### `ConcurrentSkipListMap` ğŸ”’

å®ç°äº† `ConcurrentNavigableMap` æ¥å£ï¼ŒåŸºäºè·³è¡¨çš„æœ‰åºå“ˆå¸Œè¡¨ï¼Œä½¿ç”¨CASä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

Keyã€Valueä¸èƒ½ä¸º `null`ï¼ŒKeyå¿…é¡»æ˜¯ `Comparable`ï¼Œæˆ–è€…åˆ›å»º ConcurrentNavigableMapæ—¶ï¼Œæä¾›ä¸€ä¸ª Comparator ç”¨äºæ’åºã€‚

### `ConcurrentSkipListSet` ğŸ”’

å®ç°äº† `NavigableSet` æ¥å£ï¼Œå†…éƒ¨ä½¿ç”¨ `ConcurrentSkipListMap` çš„Keyå€¼æ¥å‚¨å­˜æ•°æ®ã€‚

## Java 7

### `TransferQueue` ğŸ”’

```java
boolean tryTransfer(E e);
void transfer(E e) throws InterruptedException;
boolean tryTransfer(E e, long timeout, TimeUnit unit) throws InterruptedException;
boolean hasWaitingConsumer();
int getWaitingConsumerCount();
```

ç»§æ‰¿è‡ª `BlockingQueue`ï¼Œåœ¨ BlockingQueue çš„åŸºç¡€ä¸Šï¼ŒTransferQueue åˆ™æ›´è¿›ä¸€æ­¥ï¼Œæ–°æ·»åŠ çš„transferæ–¹æ³•ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§è€…ï¼Œç›´åˆ°æ‰€æ·»åŠ åˆ°é˜Ÿåˆ—çš„å…ƒç´ è¢«æŸä¸€ä¸ªæ¶ˆè´¹è€…æ‰€æ¶ˆè´¹ã€‚

### `LinkedTransferQueue` ğŸ”’

å®ç°äº† `TransferQueue` æ¥å£ï¼ŒåŸºäºé“¾è¡¨çš„æ— ç•Œé˜Ÿåˆ—ã€‚é€šè¿‡ `LockSupport` å®ç°ç­‰å¾…é€šçŸ¥ï¼Œä½¿ç”¨ CAS å®ç°æ— é˜»å¡çš„çº¿ç¨‹å®‰å…¨ã€‚

æ¶ˆè´¹è€…çº¿ç¨‹åˆ°é˜Ÿåˆ—ä¸­å–å…ƒç´ æ—¶ï¼Œå¦‚æœå‘ç°é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¼šç”Ÿæˆä¸€ä¸ª null èŠ‚ç‚¹ï¼Œç„¶å park ä½ç­‰å¾…ç”Ÿäº§è€…ã€‚åé¢å¦‚æœç”Ÿäº§è€…çº¿ç¨‹å…¥é˜Ÿæ—¶å‘ç°æœ‰ä¸€ä¸ª null å…ƒç´ èŠ‚ç‚¹ï¼Œè¿™æ—¶ç”Ÿäº§è€…å°±ä¸ä¼šå…¥åˆ—äº†ï¼Œç›´æ¥å°†å…ƒç´ å¡«å……åˆ°è¯¥èŠ‚ç‚¹ä¸Šï¼Œå”¤é†’è¯¥èŠ‚ç‚¹çš„çº¿ç¨‹ï¼Œè¢«å”¤é†’çš„æ¶ˆè´¹è€…çº¿ç¨‹ä¼šç›´æ¥è·å–å…ƒç´ ã€‚

>ä»åŠŸèƒ½è§’åº¦æ¥è®²ï¼ŒLinkedTransferQueue å®é™…ä¸Šæ˜¯ ConcurrentLinkedQueueã€SynchronousQueueï¼ˆå…¬å¹³æ¨¡å¼ï¼‰å’Œ LinkedBlockingQueue çš„è¶…é›†ã€‚è€Œä¸” LinkedTransferQueue æ›´å¥½ç”¨ï¼Œå› ä¸ºå®ƒä¸ä»…ä»…ç»¼åˆäº†è¿™å‡ ä¸ªç±»çš„åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†æ›´é«˜æ•ˆçš„å®ç°ã€‚
>\- [Doug Lea](http://cs.oswego.edu/pipermail/concurrency-interest/2009-February/005888.html)

### `ConcurrentLinkedDeque` ğŸ”’

å®ç°äº† `Deque` æ¥å£ï¼ŒåŸºäºé“¾è¡¨çš„éé˜»å¡æ— ç•ŒåŒç«¯é˜Ÿåˆ—ã€‚ä½¿ç”¨ CAS ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

## Java 8

ç®¡é“å’Œæµ

