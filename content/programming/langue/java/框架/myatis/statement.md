---
title: statement
date: "2020-12-10 23:10:25"
modifyDate: "2020-12-10 23:10:25"
draft: true
---
### StatementHandler
一个接口，通过prepare方法获取Statement，其余batch、update、query、queryCursor使用入参Statement执行sql，getBoundsql、getParamterHandler则用来获取内部属性，parameterize不知干什么用的。
### BaseStatementHandler
实现了StatementHandler接口的抽象类，实现了prepare、getBoundSql、getParameterHandler。prepare方法内首先调用instantiateStatement创建出Statement，之后会对Statement设置timeout、fetchSize，如果期间出现异常会关闭这个Statement。该类有三个子类PreparedStatementHandler、CallableStatementHandler、SimpleStatementHandler。

### SimpleStatementHandler
继承了BaseStatementHandler
方法instantiateStatement，根据MappedSatemnet的ResultSetType是否为ResultSetType.DEFAULT来选择Statement的创建方式，如果是则调用Connect.createStatement，不是则调用有ResultSentTye入参的重载方法。
query、queryCursor方法都是先从BoundSql中获取sql，而后sql交给Statemnet执行，最后通过ResultSetHandler的方法以Statement为入参处理返回的数据并返回。
batch方法只是从BoundSql获取sql并添加到Statement中。
update方法，从BoundSql取出sql和parameterObject，从MappedStatement取出keyGenerator，而后调用statemnet执行sql，如果keyGenerator是JdbcKeyGenerator的实例则execute方法时多个Statement.RETURN_GENERATED_KEYS入参，获取更新行计数rows，若keyGenerator是Jdbc3KeyGenerator或SelectKeyGenerator的实例则调用KeyGenerator的processAfter方法，最后返回rows。

### PreparedStatementHandler
继承了BaseStatementHandler
方法instantiateStatement，首先从BoundSql获取sql，如果MappedStatement的KeyGenererator是Jdbc3KeyGenerator实例，那么根据有autoKeyColumnNames则采用没有则使用默认值调用Connect.prepareStatement创建Statement返回。接下来依据MappedStatement的ResultSetType的类型来创建Statement，如果只是默认值则直接建档创建Statement返回，是其它值则作为入参创建Statement返回。
方法query、queryCursor调用入参转成PrepareStatement的execute方法，调用resultSetHandler实例处理结果集。
方法batch则直接调用PreparedStatement的addBatch方法。
方法update，入参转成PrepareStatement，调用execute，记录更新行数rows，调用keyGenerator的ProcessAfter方法，最后返回rows。

### CallableStatementHandler 
继承了BaseStatementHandler。
方法instantiateStatement，从BoundSql中获取sql，依据MappedStatement中的ResultSetType类型调用Connect.prepareCall创建Statement。
方法query、queryCursor，入参转成CallableStatement，调用它的execute方法，调用ResultSetHandler的handleResultSets/handleCursorResultSets方法处理结果集，调用ResultSetHandler的handleOutParameters处理出参，最后返回数据集合。
方法batch，入参转CallableStatement，调用addBach方法就返回。其余接口方法都直接委托给这个委托对象。
方法update，入参转CallableSatement，执行execute、记录更新行数rows，调用KeyGenerator的processAfter方法，调用ResultSetHandler的handleOutputParameters方法，最后返回rows。
方法parameterize，先调用一个私有方法registerOutputParameters方法。registerOutputParamters方法，从BoundSql中获取ParameterMapping列表，迭代这个列表，如果参数模式为OUT或INOUT，则根据参数的JdbcType类型调用CallableStatement的registerOutParameter注册OUT参数，如果JdbcType为null则会抛出异常。

### RoutingStatementHandler
直接实现了StatementHandler接口。在构造方法中依据MappedStatement的StatementType的STATEMENT、PREPARED、CALLABLE等类型创建SImpleStatementHandler、PrepareStatementHandler、CallableStatementHandler等对应的StatementHandler实例，除这些之外默认抛出ExecutorException。

### StatementUtil
一个工具类，只有一个静态方法applyTransactionTimeout。如果transactionTimeout为null则直接返回；如果queryTimeout为null或为0，则使用transactionTimeout，反则只有在transactionTimeout小于queryTimeout下，使用transactionTimeout。最后判断确认的值不为null，成立则使用这个值对Statemnet调用setQueryTimeout配置查询超时时间。
