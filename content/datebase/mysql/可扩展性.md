---
title: 可扩展性
date: "2020-12-10 23:10:25"
modifyDate: "2020-12-10 23:10:25"
draft: true
---
### 基本概念

简要的说，可扩展性表明了当需要增加资源以执行更多工作时系统能够获得划算的等同提升的能力。系统容量表示在一定时间内能够完成的工作量，但容量必须是可以有效利用的。系统的最大吞吐量不等同于容量。大多数基准测试能够衡量一个系统的最大吞吐量，但真实的系统一般不会使用到极限。如果达到最大吞吐量，则性能会下降，并且响应时间会变得不可接受的大且非常不稳定。我们将系统的真实容量定义为保证可接受性能的情况下能够达到的吞吐量。

用数学上的描述为：可扩展性是当增加资源以处理负载和增加的容量时系统能够获得的投资产出率（ROI）。

### 可扩展性模型

大部分系统都只能以彼线性扩展率低的扩展系数扩展。[Neil J. Gunther]( https://en.wikipedia.org/wiki/Neil_J._Gunther )博士提出的通过可扩展性定律（Universal Scalability Law，USL）通过两个因素建立模型：无法并行执行的一部分工作，以及需要交互的另外一部分工作。内部节点间或者进程间的通信。

为第一个因素建模就有了著名的[Amdahld定律]( [https://en.wikipedia.org/wiki/Amdahl%27s_law)，它会导致吞吐量趋于平缓。如果部分工作无法并行，那么不管如何分而治之，该任务至少需要串行部分的时间。第二个因素导致的通信的代价取决于通信信道的数量，而信道的数量按照系统内工作者数量的二次方增长。因此最终开销比带来的首席增长的慢，这是产生扩展性倒退的原因。

![](https://i.loli.net/2020/08/27/1UrZMWa8VHSPDIf.jpg)

### 扩展MySQL

> - 垂直分区，以表为单位，把不同的表分散到不同的数据库或主机上。特点是规则简单，实施方便，适合业务之间耦合度低的系统。
> - 水平分区，以行为单位，将同一个表的数据按照某种规则拆分到不同的数据库或主机上。特点是相对负责，适合单表巨大的系统

#### 规划可扩展性

人们通常只有在无法满足增加的负载时才会考虑扩展性，具体表现为工作负载从CPU密集型标为I/O密集型，并发查询的竞争，以及不断增大的延迟。主要原因是查询的复杂度增加或者内存中驻留着一部分不在使用的数据或者索引。如果是可扩展的应用，则可以简单的增加更多的服务器来分担负载，这样就没有性能问题了。

通过规划可扩展性来解决应用的不可扩展问题。规划可扩展性首先是估算需要承担的负载到底有多少，其次是大致正确地估算日程表。

#### 准备工作

- 优化性能

  很多时候可以通过简单的改动来获得明显的性能提升。

- 购买性能更强的硬件

  升级或增加服务器在某些场景下行之有效，特别是对处于软件生命周期早期的应用，购买更多的服务器或者增加内存通常是个好办法。

#### 垂直扩展

垂直扩张（也称向上扩展、横向扩展）意味着购买更多性能强悍的硬件，对很多应用来说这是唯一需要做的事情。这种策略有很多好处。例如，单台服务器比多台服务器更加容易维护和开发，能显著节约开销。在单台服务器上备份和恢复应用同样很简单，因为无需关心一致性或者哪个数据集更权威。从复杂性的成本来说，垂直扩展也比水平扩展更简单。

垂直扩展的策略能够顶一段时间，实际上很多应用是不会达到天花板的。但是如果应用变的非常庞大，垂直扩展就没有办法了。第一个原因是钱，从某中角度来看，垂直扩展都是个糟糕的财务决策，当超出硬件能够提供的最优性价比是，就会需要非同寻常的特殊配置的硬件，这样的硬件往往非常昂贵。最后，垂直扩展不是无限制的，即使最强大的计算机也有限制。

单服务器应用通常会首先达到读限制，特别是执行复杂的读查询。类似这样的查询在MySQL内部是单线程的，因此只能使用一个CPU，这种情况下花钱也无法提升多少性能。增加更多的CPU和CPU核数并不能是慢查询执行得更快。当数据变得庞大以至于无法有效缓存时，内存也会成为瓶颈，这通常表现为很高得磁盘使用率，而磁盘是现代计算机中最慢得部分。

#### 水平扩展

可以把水平扩展（向外扩展）策略划分为三个部分：复制、拆分以及数据分片。

##### 复制

最简单也是最常见得水平扩展的方法是通过复制将数据分发到多个服务器上，让后将备库用于读查询。这种技术对于以读为主的应用很有效。它有些缺点，例如重复缓存，但如果数据规模有限这就不是问题。

##### 拆分

另外一个比较常见的水平扩展方法是将工作负载分布到多个节点。按功能拆分，或者说按职责拆分，每个节点只包含特定功能所需要的数据。另一个可能的功能划分方法是对单个服务器的数据进行划分，并确保划分的表集合之间不会由关联操作。当必须执行关联操作时，如果对性能要求不高，可以在应用中做关联。

归根结底，还是不能通过功能划分来无限地扩展，因为如果一个功能区域被捆绑到单个MySQL节点，就只能进行垂直扩展。其中一个应用或者功能区域最终增长到非常庞大时，都会迫使你区寻找一个不同的策略。如果进行了太多的功能划分，以后就很难采用更具扩展性的设计了。

##### 数据分片

在目前用于扩展大型MySQL应用方案中，数据分片时最通用且最成功的方法。它把数据分割成小片，或者说一块，然后储存在不同的节点中。只有单台主库，那么不管多少备库，写容量都是无法扩展的，而数据分片就是首选得技术方案。

采用分片的应用常会有一个数据库访问抽象层，用以降低应用和分片数据储存之间通信的复杂度，但是这样的抽象层会导致一些低效率问题。

数据分片在和某些类型的按功能划分联合使用时非常有用。大多数分片系统也会有一些全局的不会被分片的数据，这些数据一般储存在单个节点上，通过保存在memecached这样的缓存中。

分区键决定了每一行分配到哪个分配中。分区键的选择和使用方法如下：

- 静态分片模式，即分区键是静态分配的，一般使用范围或者哈希函数。这种模式虽然简单，但明显的缺陷便是存在数据不均匀的情况。
  - 哈希函数
  - 取模运算
  - 范围约定

- 动态分片模式，即分区函数将从字典中查找分区键，让后定位具体哪个分片储存了数据。这种模式比静态模式更加灵活，但是需要一个集中储存来存放字典，每次查找数据都需要执行两次查询，并且集中储存本身还可能存在单点故障。
- 混合分片模式

### 分片工具

在设计数据分片应用时，首先要做的是编写能够查询多个数据源的代码。如果没有任何抽象层，直接让应用访问多个数据源，那绝对是一个很差的设计，因为这位增加大量的编码复杂性。最好的办法是将数据源隐藏在抽象层中。这个抽象层主要完成一下任务：

- 连接到正确的分片并执行查询。
- 分布式一致性校验。
- 跨分片结果集聚合。
- 跨分片关联操作。
- 锁和事务管理。
- 创建新的数据分片。



