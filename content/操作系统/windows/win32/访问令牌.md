## 访问令牌(Access Token)

访问令牌是描述进程或线程的安全上下文的对象。与特定的windows账户关联，账户环境下启动的所有进程都会获得该令牌的副本，进程中的线程默认获得这个令牌。令牌中的信息包括与进程或线程关联的用户帐户的标识和特权信息。当用户登录时，系统通过将用户密码与安全数据库（如域认证中的NTDS或本地认证中的SAM文件）中存储的信息进行比较来验证用户密码。如果密码经过验证，则系统将生成访问令牌。代表该用户执行的每个进程都有此访问令牌的副本。（通常我们在输入密码登陆进入Windows界面时就是一个生成访问令牌的过程）
当线程与安全对象进行交互或尝试执行需要特权的系统任务时，系统使用访问令牌来标识用户。访问令牌包含以下信息：
用户帐户的安全标识符（SID）（关SID是什么后续章节会详细介绍）
用户所在组的SID
标识当前登录会话（logon session）的登录SID
用户或用户组拥有的特权列表
所有者SID
主要组的SID
用户创建安全对象而不指定安全描述符时系统使用的默认DACL

### 访问令牌的来源

令牌是主要令牌（内核分配的令牌）还是模拟令牌（模拟而来的令牌）
受限制SID的可选列表（如UAC存在时会针对某些账户删除某些特权）
当前的模拟级别
其他数据

### 产生大致过程

使用凭据(用户密码)进行认证
当前登录会话的Session创建
Windows此时会返回用户sid和用户组sid
LSA(Local Security Authority)创建一个Token
依据该token创建进程、线程(如果CreaetProcess时自己指定了 Token, LSA会用该Token， 否则就继承父进程Token进行运行)
Windows Access Token分两种：
主令牌（Primary token）
模拟令牌（Impersonation token）
每个进程都有一个主要令牌，用于描述与该进程关联的用户帐户的安全上下文。默认情况下，当进程的线程与安全对象进行交互时，系统使用主令牌。
此外，线程可以模拟客户端帐户。模拟允许线程使用客户端的安全上下文与安全对象进行交互。模拟客户端的线程同时具有主令牌和模拟令牌。（出现这种情况是因为服务操作是在寄宿进程中执行，在默认的情况下，服务操作是否具有足够的权限访问某个资源（比如文件）取决于执行寄宿进程Windows帐号的权限设置，而与作为客户端的Windows帐号无关。在有多情况下，我们希望服务操作执行在基于客户端的安全上下文中执行，以解决执行服务进行的帐号权限不足的问题。简单来说就是我们希望不同客户端来访问服务时，服务可以模拟客户端的身份去访问服务，而不是用自己的主进程Token身份去访问。）